<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Profesional - Versión 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            transition: background-color 0.5s ease;
            font-size: 18px;
        }

        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .locked-overlay { pointer-events: none; opacity: 0.6; filter: grayscale(0.5); }
        .read-only-box { @apply p-3 bg-slate-50 border border-slate-100 rounded-xl font-semibold text-slate-500 text-xs italic; }
        
        /* Pestañas Estilo Chrome - Versión 3 */
        .chrome-tab-container {
            @apply flex gap-1 bg-slate-200/40 pt-2 px-4 rounded-t-[2rem] border-b border-slate-200;
        }
        .chrome-tab {
            /* Ajuste de fuente: de 9px a 11px para mayor legibilidad */
            @apply relative px-5 py-3 text-[11px] font-extrabold uppercase tracking-[0.05em] cursor-pointer transition-all rounded-t-xl text-slate-400 hover:bg-white/40 flex items-center gap-2;
            min-width: 160px;
            justify-content: center;
        }
        .chrome-tab-active {
            @apply bg-white shadow-[0_-2px_8px_rgba(0,0,0,0.03)] z-10 text-slate-700;
        }
        .chrome-tab-active::before, .chrome-tab-active::after {
            content: '';
            @apply absolute bottom-0 w-3 h-3 bg-transparent pointer-events-none;
        }
        .chrome-tab-active::before {
            left: -12px;
            @apply rounded-br-xl;
            box-shadow: 6px 0 0 0 white;
        }
        .chrome-tab-active::after {
            right: -12px;
            @apply rounded-bl-xl;
            box-shadow: -6px 0 0 0 white;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const THEMES = {
            ocean: { primary: '#0ea5e9', bg: 'bg-sky-50' },
            emerald: { primary: '#10b981', bg: 'bg-emerald-50' },
            sunset: { primary: '#f59e0b', bg: 'bg-amber-50' },
            berry: { primary: '#8b5cf6', bg: 'bg-violet-50' }
        };

        const INTERES_OPTIONS = [
            "Sin interés <No muestra intención real de avanzar>",
            "Interés Bajo <Escucha, pregunta poco, no toma acción.>",
            "Interés Medio <Hace preguntas, pide información, evalúa.>",
            "Interés Alto <Quiere avanzar, pregunta por precio, tiempos o pasos.>"
        ];

        const ESTADO_OPTIONS = ["Seguimiento", "Venta", "Contactar más tarde", "No interesado"];

        const toInputDate = (str) => {
            if (!str || !str.includes('/')) return str;
            const [d, m, y] = str.split('/');
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        };

        const toSheetDate = (str) => {
            if (!str) return '';
            if (str.includes('/')) return str;
            const [y, m, d] = str.split('-');
            return `${d}/${m}/${y}`;
        };

        const App = () => {
            const [user, setUser] = useState(localStorage.getItem('crm_user') || null);
            const [theme, setTheme] = useState(localStorage.getItem('crm_theme') || 'ocean');
            const [agents, setAgents] = useState([]);
            const [clients, setClients] = useState([]);
            const [loading, setLoading] = useState(false);
            const [modal, setModal] = useState(null); 
            const [selectedClient, setSelectedClient] = useState(null);
            const [filters, setFilters] = useState({ name: '', status: '', interest: '' });

            const activeTheme = THEMES[theme];

            useEffect(() => {
                fetchAgents();
                if (user) fetchClients(user);
            }, []);

            const fetchAgents = async () => {
                const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/agents');
                const data = await res.json();
                setAgents(data);
            };

            const fetchClients = async (name) => {
                setLoading(true);
                const res = await fetch(`https://crmasesorasapi.libresdeumas.com/api/clients?asesora=${name}`);
                const data = await res.json();
                setClients(data);
                setLoading(false);
            };

            const handleLogin = async (name, password) => {
                setLoading(true);
                const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: name, password })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    setUser(name);
                    localStorage.setItem('crm_user', name);
                    fetchClients(name);
                } else { alert(data.message); }
                setLoading(false);
            };

            const filteredClients = useMemo(() => {
                const search = filters.name.toLowerCase();
                return clients.filter(c => {
                    // Función de búsqueda que permite filtrar por Nombre o por Teléfono (Canal)
                    const matchesSearch = 
                        c.Nombre.toLowerCase().includes(search) || 
                        (c['Canal (Tel/WhatsApp)'] || c['Canal'] || '').toString().includes(search);

                    return matchesSearch &&
                        (filters.status === '' || c['Estado Final'] === filters.status) &&
                        (filters.interest === '' || (c['Nivel de Interés'] && c['Nivel de Interés'].includes(filters.interest)))
                });
            }, [clients, filters]);

            if (!user) return <LoginScreen agents={agents} onLogin={handleLogin} loading={loading} theme={activeTheme} />;

            return (
                <div className={`min-h-screen ${activeTheme.bg} p-4 md:p-6 transition-all duration-500`}>
                    <header className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-md" style={{backgroundColor: activeTheme.primary}}>
                                <i className="fas fa-users-cog text-xl"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-extrabold text-slate-800 tracking-tight uppercase">CRM {user}</h1>
                                <p className="text-slate-400 text-[8px] font-bold uppercase tracking-widest">Dashboard • Versión 3</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3 glass p-1.5 rounded-full shadow-sm border border-white mt-4 md:mt-0">
                            {Object.keys(THEMES).map(t => (
                                <button key={t} onClick={() => {setTheme(t); localStorage.setItem('crm_theme', t);}} className={`w-6 h-6 rounded-full transition-all ${theme === t ? 'ring-2 ring-offset-1 ring-slate-300 scale-105' : 'opacity-40 hover:opacity-100'}`} style={{backgroundColor: THEMES[t].primary}} />
                            ))}
                            <div className="w-px h-4 bg-slate-200 mx-1" />
                            <button onClick={() => {localStorage.clear(); window.location.reload();}} className="text-slate-300 hover:text-red-500 p-1.5 transition-colors"><i className="fas fa-sign-out-alt text-sm"></i></button>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <input type="text" placeholder="Buscar por nombre o teléfono..." className="w-full px-5 py-3 rounded-2xl border-none shadow-sm font-semibold text-sm focus:ring-2 focus:ring-offset-1 ring-sky-300 outline-none transition-all" value={filters.name} onChange={e => setFilters({...filters, name: e.target.value})} />
                            <select className="px-5 py-3 rounded-2xl border-none shadow-sm font-semibold text-sm text-slate-500 outline-none" value={filters.status} onChange={e => setFilters({...filters, status: e.target.value})}>
                                <option value="">Estado</option>
                                {ESTADO_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                            <select className="px-5 py-3 rounded-2xl border-none shadow-sm font-semibold text-sm text-slate-500 outline-none" value={filters.interest} onChange={e => setFilters({...filters, interest: e.target.value})}>
                                <option value="">Interés</option>
                                {INTERES_OPTIONS.map(o => <option key={o} value={o.split(' <')[0]}>{o.split(' <')[0]}</option>)}
                            </select>
                            <button onClick={() => setModal('new')} className="text-white font-bold py-3 px-6 rounded-2xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 uppercase text-xs tracking-wider" style={{backgroundColor: activeTheme.primary}}>
                                <i className="fas fa-plus"></i> Nuevo Cliente
                            </button>
                        </div>

                        <div className="glass rounded-[2rem] shadow-xl overflow-hidden border border-white">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-slate-50/40">
                                        <tr className="text-slate-400 text-[9px] uppercase font-bold tracking-widest">
                                            <th className="px-6 py-4">Nombre</th>
                                            <th className="px-6 py-4">Canal</th>
                                            <th className="px-6 py-4">Interés</th>
                                            <th className="px-6 py-4">Registro</th>
                                            <th className="px-6 py-4">Próx. Cto.</th>
                                            <th className="px-6 py-4">Estado</th>
                                            <th className="px-6 py-4 text-right pr-10">Gestión</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredClients.map((c, i) => (
                                            <tr key={i} className="hover:bg-white/60 transition-colors">
                                                <td className="px-6 py-4 font-bold text-slate-700 text-xs">{c.Nombre}</td>
                                                <td className="px-6 py-4 text-[11px] text-slate-500">{c['Canal (Tel/WhatsApp)'] || c['Canal']}</td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-2 py-0.5 rounded text-[8px] font-bold uppercase ${c['Nivel de Interés'] && c['Nivel de Interés'].includes('Alto') ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-400'}`}>
                                                        {c['Nivel de Interés'] ? c['Nivel de Interés'].split(' <')[0] : 'N/A'}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 text-[10px] text-slate-400">{c['Fecha 1er Contacto']}</td>
                                                <td className="px-6 py-4 text-[10px] font-bold text-sky-600">{c['Fecha Próx. Contacto'] || '--'}</td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-2 py-1 rounded-lg border text-[8px] font-bold uppercase tracking-tight ${
                                                        c['Estado Final'] === 'Venta' ? 'bg-green-50 text-green-700 border-green-100' :
                                                        c['Estado Final'] === 'No interesado' ? 'bg-red-50 text-red-700 border-red-100' :
                                                        c['Estado Final'] === 'Contactar más tarde' ? 'bg-slate-50 text-slate-400 border-slate-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'
                                                    }`}>
                                                        {c['Estado Final']}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 text-right pr-10">
                                                    <button onClick={() => {setSelectedClient(c); setModal('edit');}} className="w-9 h-9 rounded-xl bg-white shadow-sm flex items-center justify-center ml-auto hover:bg-sky-50 hover:text-sky-600 transition-all border border-slate-100 outline-none">
                                                        <i className="fas fa-folder-open text-slate-300 text-sm"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>

                    {modal === 'new' && <NewClientModal theme={activeTheme} user={user} onClose={() => setModal(null)} onRefresh={() => fetchClients(user)} />}
                    {modal === 'edit' && <EditClientModal theme={activeTheme} client={selectedClient} onClose={() => setModal(null)} onRefresh={() => fetchClients(user)} />}
                </div>
            );
        };

        const LoginScreen = ({ agents, onLogin, loading, theme }) => {
            const [selected, setSelected] = useState('');
            const [pass, setPass] = useState('');
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                    <div className="max-w-sm w-full glass p-10 rounded-[3rem] shadow-xl border border-white text-center">
                        <div className="w-20 h-20 mx-auto rounded-3xl flex items-center justify-center text-white mb-6 shadow-lg" style={{backgroundColor: theme.primary}}>
                            <i className="fas fa-user-lock text-3xl"></i>
                        </div>
                        <h2 className="text-2xl font-black text-slate-800 tracking-tight uppercase mb-8">Acceso CRM</h2>
                        <div className="space-y-4">
                            <select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm border-none outline-none shadow-inner" value={selected} onChange={e => setSelected(e.target.value)}>
                                <option value="">Seleccionar Asesora</option>
                                {agents.map(a => <option key={a} value={a}>{a}</option>)}
                            </select>
                            <input type="password" placeholder="Contraseña" className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm border-none outline-none shadow-inner" value={pass} onChange={e => setPass(e.target.value)} />
                            <button onClick={() => onLogin(selected, pass)} disabled={loading || !selected || !pass} className="w-full py-4 rounded-2xl text-white font-bold text-lg shadow-lg hover:brightness-105 transition-all" style={{backgroundColor: theme.primary}}>
                                {loading ? 'ESPERE...' : 'INGRESAR'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const NewClientModal = ({ theme, user, onClose, onRefresh }) => {
            const [form, setForm] = useState({ 
                Nombre: '', Canal: '', 'Fecha 1er Contacto': toSheetDate(new Date().toISOString().split('T')[0]), 
                'Nivel de Interés': INTERES_OPTIONS[2], 'Resumen Conversación': '', 'Fecha Próx. Contacto': '', 'Asesora': user, 'Estado Final': 'Seguimiento'
            });
            const [files, setFiles] = useState([]);
            const [sending, setSending] = useState(false);

            const save = async (e) => {
                if (e) e.preventDefault();
                if (form.Canal.length !== 10) return alert("El teléfono debe tener 10 números.");
                setSending(true);
                const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/add-client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...form, files_payload: files })
                });
                if (res.ok) { onRefresh(); onClose(); }
                setSending(false);
            };

            const handleFiles = (e) => {
                const selectedFiles = Array.from(e.target.files);
                const promises = selectedFiles.map(file => {
                    return new Promise((resolve) => {
                        const r = new FileReader();
                        r.onloadend = () => resolve({ base64Data: r.result.split(',')[1], contentType: file.type, name: file.name });
                        r.readAsDataURL(file);
                    });
                });
                Promise.all(promises).then(payloads => setFiles(prev => [...prev, ...payloads]));
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-in zoom-in duration-300">
                        <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/20">
                            <h3 className="text-lg font-black text-slate-800 tracking-tight uppercase">Nuevo Prospecto</h3>
                            <button type="button" onClick={onClose} className="w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center text-slate-300 hover:text-red-500 transition-all outline-none border-none"><i className="fas fa-times text-sm"></i></button>
                        </div>
                        <form onSubmit={save} className="p-8 space-y-4 max-h-[75vh] overflow-y-auto custom-scroll">
                            <input required type="text" placeholder="Nombre completo" className="w-full p-4 bg-slate-50 rounded-2xl font-semibold text-sm border-none shadow-inner outline-none" onChange={e => setForm({...form, Nombre: e.target.value})} />
                            <div className="grid grid-cols-2 gap-4">
                                <input required type="text" maxLength="10" placeholder="WhatsApp (10 dígitos)" className="w-full p-4 bg-slate-50 rounded-2xl font-semibold text-sm border-none shadow-inner outline-none" value={form.Canal} onChange={e => setForm({...form, Canal: e.target.value.replace(/\D/g, '')})} />
                                <select className="w-full p-4 rounded-2xl bg-slate-50 font-semibold text-sm border-none shadow-inner outline-none" value={form['Estado Final']} onChange={e => setForm({...form, 'Estado Final': e.target.value})}>
                                    {ESTADO_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                                </select>
                            </div>
                            <select className="w-full p-4 rounded-2xl bg-slate-50 font-semibold text-sm border-none shadow-inner outline-none" value={form['Nivel de Interés']} onChange={e => setForm({...form, 'Nivel de Interés': e.target.value})}>
                                {INTERES_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-[8px] font-bold text-slate-400 uppercase ml-2">Registro</label>
                                    <input required disabled type="date" value={toInputDate(form['Fecha 1er Contacto'])} className="w-full p-4 bg-slate-50 rounded-2xl font-semibold text-sm border-none shadow-inner outline-none" onChange={e => setForm({...form, 'Fecha 1er Contacto': toSheetDate(e.target.value)})} />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[8px] font-bold text-slate-400 uppercase ml-2">Próximo Contacto</label>
                                    <input required type="date" className="w-full p-4 bg-slate-50 rounded-2xl font-semibold text-sm border-none shadow-inner outline-none" onChange={e => setForm({...form, 'Fecha Próx. Contacto': toSheetDate(e.target.value)})} />
                                </div>
                            </div>
                            <textarea required placeholder="Resumen inicial..." className="w-full p-5 bg-slate-50 rounded-[1.5rem] font-medium text-sm h-24 border-none shadow-inner outline-none" onChange={e => setForm({...form, 'Resumen Conversación': e.target.value})}></textarea>
                            <div className="p-8 border-2 border-dashed border-slate-200 rounded-[2rem] text-center relative cursor-pointer hover:bg-slate-50 group transition-all">
                                <input multiple type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFiles} />
                                <i className="fas fa-camera text-3xl text-slate-200 mb-2 group-hover:text-sky-300"></i>
                                <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{files.length > 0 ? `✓ ${files.length} CARGADAS` : 'ADJUNTAR FOTOS'}</p>
                            </div>
                            <button type="submit" disabled={sending} className="w-full py-4 rounded-2xl text-white font-bold text-md shadow-lg transition-all" style={{backgroundColor: theme.primary}}>
                                {sending ? 'REGISTRANDO...' : 'GUARDAR EXPEDIENTE'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const EditClientModal = ({ theme, client, onClose, onRefresh }) => {
            const [tab, setTab] = useState('base'); 
            const [sending, setSending] = useState(false);
            const [local, setLocal] = useState({...client});
            const [newPhotos, setNewPhotos] = useState([]);

            const isLocked = client['Estado Final'] === 'Venta' || client['Estado Final'] === 'No interesado';

            const completedList = useMemo(() => {
                let list = [];
                for(let i=1; i<=30; i++) {
                    if(client[`Fecha Seguimiento ${i}`] && client[`Fecha Seguimiento ${i}`].toString().trim() !== "") {
                        list.push({
                            n: i,
                            fecha: client[`Fecha Seguimiento ${i}`],
                            nota: client[`Notas Seguimiento ${i}`]
                        });
                    }
                }
                return list;
            }, [client]);

            const nextFollowUp = completedList.length > 0 ? completedList[completedList.length - 1].n + 1 : 1;

            // Bloquear fecha de gestión al día de hoy para nuevas gestiones
            useEffect(() => {
                if (tab === 'new') {
                    setLocal(prev => ({
                        ...prev,
                        [`Fecha Seguimiento ${nextFollowUp}`]: toSheetDate(new Date().toISOString().split('T')[0])
                    }));
                }
            }, [tab, nextFollowUp]);

            const update = async (e) => {
                if (e) e.preventDefault();
                if (isLocked) return;
                setSending(true);
                const updates = {
                    'Estado Final': local['Estado Final'],
                    'Nivel de Interés': local['Nivel de Interés'],
                    'Fecha Próx. Contacto': local['Fecha Próx. Contacto'],
                    'Comentarios': local['Comentarios'],
                };
                if (tab === 'new') {
                    const n = nextFollowUp;
                    const previousContactDate = client['Fecha Próx. Contacto'] || 'No definida';
                    const noteHeader = `Fecha de contacto anterior: ${previousContactDate}`;
                    const userNote = local[`Notas Seguimiento ${n}`] || '';
                    updates[`Fecha Seguimiento ${n}`] = local[`Fecha Seguimiento ${n}`];
                    updates[`Notas Seguimiento ${n}`] = `${noteHeader}\n${userNote}`;
                }
                const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/update-client-advanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre_original: client.Nombre, updates, files_payload: newPhotos })
                });
                if (res.ok) { onRefresh(); onClose(); }
                setSending(false);
            };

            const handleFiles = (e) => {
                const selectedFiles = Array.from(e.target.files);
                const promises = selectedFiles.map(file => {
                    return new Promise((resolve) => {
                        const r = new FileReader();
                        r.onloadend = () => resolve({ base64Data: r.result.split(',')[1], contentType: file.type, name: file.name });
                        r.readAsDataURL(file);
                    });
                });
                Promise.all(promises).then(payloads => setNewPhotos(prev => [...prev, ...payloads]));
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-4xl rounded-[3rem] shadow-2xl flex flex-col h-[85vh] overflow-hidden animate-in zoom-in duration-300">
                        <div className="p-8 flex justify-between items-center bg-white">
                            <div>
                                <h3 className="text-xl font-black text-slate-800 tracking-tight leading-none">{client.Nombre}</h3>
                                {isLocked && <span className="text-[8px] font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded-full mt-2 inline-block border border-red-100 uppercase tracking-widest leading-none">Cerrado</span>}
                            </div>
                            <div className="flex gap-3">
                                {client.Imagenes && <a href={client.Imagenes} target="_blank" className="text-sky-600 font-bold text-[10px] bg-sky-50 px-4 py-3 rounded-2xl hover:bg-sky-100 transition-all flex items-center gap-2 outline-none"><i className="fas fa-folder-open"></i> DRIVE</a>}
                                <button type="button" onClick={onClose} className="w-9 h-9 rounded-full bg-white shadow-md flex items-center justify-center text-slate-300 hover:text-red-500 transition-all border-none outline-none"><i className="fas fa-times text-sm"></i></button>
                            </div>
                        </div>

                        {/* PESTAÑAS CHROME STYLE */}
                        <div className="chrome-tab-container">
                            <button type="button" onClick={() => setTab('base')} className={`chrome-tab ${tab === 'base' ? 'chrome-tab-active' : ''}`} style={tab === 'base' ? {color: theme.primary} : {}}>
                                <i className="fas fa-id-badge text-xs mr-1"></i> Ficha Base
                            </button>
                            <button type="button" onClick={() => setTab('history')} className={`chrome-tab ${tab === 'history' ? 'chrome-tab-active' : ''}`} style={tab === 'history' ? {color: theme.primary} : {}}>
                                <i className="fas fa-list-ul text-xs mr-1"></i> Historial
                            </button>
                            {!isLocked && (
                                <button type="button" onClick={() => setTab('new')} className={`chrome-tab ${tab === 'new' ? 'chrome-tab-active' : ''}`} style={tab === 'new' ? {color: theme.primary} : {}}>
                                    <i className="fas fa-edit text-xs mr-1"></i> Nueva Gestión
                                </button>
                            )}
                            <button type="button" onClick={() => setTab('notes')} className={`chrome-tab ${tab === 'notes' ? 'chrome-tab-active' : ''}`} style={tab === 'notes' ? {color: theme.primary} : {}}>
                                <i className="fas fa-comment-dots text-xs mr-1"></i> Notas Libres
                            </button>
                        </div>

                        <div className="flex-1 p-8 overflow-y-auto custom-scroll relative bg-white">
                            {tab === 'base' && (
                                <div className="space-y-6 animate-in fade-in duration-500">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="space-y-1"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-widest ml-1">Registro</p><div className="read-only-box">{client['Fecha 1er Contacto']}</div></div>
                                        <div className="space-y-1"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-widest ml-1">Canal</p><div className="read-only-box">{client['Canal (Tel/WhatsApp)'] || client['Canal']}</div></div>
                                        <div className="space-y-1"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-widest ml-1">Asesora</p><div className="read-only-box">{client['Asesora']}</div></div>
                                        <div className="space-y-1"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-widest ml-1">Cita</p><div className="read-only-box text-sky-600 border-sky-100">{client['Fecha Próx. Contacto'] || '--'}</div></div>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-[8px] font-bold text-slate-400 uppercase tracking-widest ml-1">Apertura</p>
                                        <div className="p-6 bg-slate-50 border border-slate-100 rounded-[2rem] font-medium text-slate-600 italic leading-relaxed text-xs">"{client['Resumen Conversación']}"</div>
                                    </div>
                                </div>
                            )}

                            {tab === 'history' && (
                                <div className="space-y-5 animate-in fade-in duration-500 max-w-3xl">
                                    <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Bitácora de Seguimientos</h4>
                                    <div className="space-y-5">
                                        {completedList.length > 0 ? completedList.map((item, idx) => (
                                            <div key={idx} className="relative pl-8 border-l border-slate-200 pb-6">
                                                <div className="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full border-2 border-white shadow-sm" style={{backgroundColor: theme.primary}}></div>
                                                <div className="bg-slate-50 p-5 rounded-[1.5rem] border border-slate-100">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-[8px] font-black uppercase tracking-widest" style={{color: theme.primary}}>Gestión #{item.n}</span>
                                                        <span className="text-[9px] font-bold text-slate-400 italic">{item.fecha}</span>
                                                    </div>
                                                    <p className="text-xs text-slate-600 leading-relaxed font-medium whitespace-pre-wrap">{item.nota}</p>
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="text-center py-10 opacity-40">
                                                <i className="fas fa-history text-3xl mb-2"></i>
                                                <p className="text-[9px] font-bold uppercase tracking-widest">Sin registros previos</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {tab === 'new' && (
                                <div className="space-y-6 animate-in slide-in-from-right-2 duration-400 max-w-3xl">
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="space-y-1">
                                            <label className="text-[8px] font-bold text-slate-300 uppercase ml-4">Fecha Gestión</label>
                                            <input type="date" disabled className="w-full p-4 bg-slate-100 rounded-2xl font-bold border-none shadow-inner opacity-60 outline-none cursor-not-allowed text-xs" value={toInputDate(local[`Fecha Seguimiento ${nextFollowUp}`])} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[8px] font-bold text-slate-300 uppercase ml-4">Próxima Cita</label>
                                            <input type="date" className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-none shadow-inner outline-none text-xs" value={toInputDate(local['Fecha Próx. Contacto'])} onChange={e => setLocal({...local, 'Fecha Próx. Contacto': toSheetDate(e.target.value)})} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="space-y-1">
                                            <label className="text-[8px] font-bold text-slate-300 uppercase ml-4">Interés</label>
                                            <select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-xs border-none outline-none shadow-inner" value={local['Nivel de Interés']} onChange={e => setLocal({...local, 'Nivel de Interés': e.target.value})}>
                                                {INTERES_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                                            </select>
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[8px] font-bold text-slate-300 uppercase ml-4">Estado</label>
                                            <select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-xs border-none outline-none shadow-inner" value={local['Estado Final']} onChange={e => setLocal({...local, 'Estado Final': e.target.value})}>
                                                {ESTADO_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <textarea className="w-full p-6 bg-slate-50 rounded-[2rem] font-medium text-xs h-36 border-none shadow-inner leading-relaxed outline-none" placeholder="Notas de la gestión..." value={local[`Notas Seguimiento ${nextFollowUp}`] || ''} onChange={e => setLocal({...local, [`Notas Seguimiento ${nextFollowUp}`]: e.target.value})}></textarea>
                                    
                                    <div className="space-y-4">
                                        <div className="p-8 border-2 border-dashed border-slate-100 rounded-[2.5rem] text-center relative cursor-pointer hover:bg-slate-50 group transition-all">
                                            <input multiple type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFiles} />
                                            <i className="fas fa-camera text-3xl text-slate-100 mb-2 group-hover:text-sky-300 transition-colors"></i>
                                            <p className="text-[8px] font-bold text-slate-300 uppercase tracking-widest">{newPhotos.length > 0 ? `✓ ${newPhotos.length} CARGADAS` : 'SUBIR FOTOS'}</p>
                                        </div>
                                        {newPhotos.length > 0 && (
                                            <div className="px-4 py-2 bg-slate-50 rounded-xl border border-slate-100 max-h-24 overflow-y-auto custom-scroll">
                                                {newPhotos.map((f, idx) => <p key={idx} className="text-[8px] font-bold text-slate-400 truncate">• {f.name}</p>)}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {tab === 'notes' && (
                                <div className="space-y-4 animate-in zoom-in-95 h-full">
                                    <h4 className="text-[8px] font-bold text-slate-400 uppercase tracking-widest ml-4">Comentarios Libres</h4>
                                    <textarea className="w-full p-8 bg-slate-50 rounded-[2.5rem] font-medium text-xs h-80 border-none shadow-inner outline-none leading-relaxed" placeholder="Anotaciones internas generales..." value={local['Comentarios'] || ''} onChange={e => setLocal({...local, 'Comentarios': e.target.value})}></textarea>
                                </div>
                            )}
                        </div>

                        <div className="p-8 bg-slate-50/50 border-t border-slate-100 flex gap-4">
                            <button type="button" onClick={onClose} className="flex-1 py-4 text-slate-400 font-bold uppercase text-[9px] tracking-widest hover:bg-slate-100 rounded-2xl transition-all border-none outline-none">Descartar</button>
                            {(!isLocked && tab !== 'base') && (
                                <button type="button" onClick={update} disabled={sending} className="flex-[2] py-4 rounded-2xl text-white font-bold text-sm shadow-xl hover:brightness-105 active:scale-95 transition-all outline-none border-none uppercase tracking-wider" style={{backgroundColor: theme.primary}}>
                                    {sending ? 'SINCRONIZANDO...' : 'Sincronizar Expediente'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>