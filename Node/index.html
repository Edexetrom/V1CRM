<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Profesional - Versión 5.6 (Memory Shield)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: background-color 0.5s ease;
            font-size: 18px;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .read-only-box {
            @apply p-3 bg-slate-50 border border-slate-100 rounded-xl font-semibold text-slate-500 text-xs italic;
        }

        .chrome-tab-container {
            @apply flex gap-1 bg-slate-200/40 pt-2 px-4 rounded-t-[2.5rem] border-b border-slate-200;
        }

        .chrome-tab {
            @apply relative px-5 py-3 text-[11px] font-extrabold uppercase tracking-[0.05em] cursor-pointer transition-all rounded-t-xl text-slate-400 hover:bg-white/40 flex items-center gap-2;
            min-width: 160px;
            justify-content: center;
            border: none;
            outline: none;
            background: transparent;
        }

        .chrome-tab-active {
            @apply bg-white shadow-[0_-2px_8px_rgba(0, 0, 0, 0.03)] z-10 text-slate-700;
        }

        .chrome-tab-active::before,
        .chrome-tab-active::after {
            content: '';
            @apply absolute bottom-0 w-3 h-3 bg-transparent pointer-events-none;
        }

        .chrome-tab-active::before {
            left: -12px;
            @apply rounded-br-xl;
            box-shadow: 6px 0 0 0 white;
        }

        .chrome-tab-active::after {
            right: -12px;
            @apply rounded-bl-xl;
            box-shadow: -6px 0 0 0 white;
        }

        @keyframes cloudPulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .sync-active {
            animation: cloudPulse 2s infinite ease-in-out;
        }

        .warning-shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const THEMES = {
            ocean: { primary: '#0ea5e9', bg: 'bg-sky-50' },
            emerald: { primary: '#10b981', bg: 'bg-emerald-50' },
            sunset: { primary: '#f59e0b', bg: 'bg-amber-50' },
            berry: { primary: '#8b5cf6', bg: 'bg-violet-50' }
        };

        const INTERES_OPTIONS = [
            "Sin interés <No muestra intención real de avanzar>",
            "Interés Bajo <Escucha, pregunta poco, no toma acción.>",
            "Interés Medio <Hace preguntas, pide información, evalúa.>",
            "Interés Alto <Quiere avanzar, pregunta por precio, tiempos o pasos.>"
        ];

        const ESTADO_OPTIONS = ["Seguimiento", "Venta", "Contactar más tarde", "No interesado"];

        // --- MOTOR DE COMPRESIÓN QUIRÚRGICO (Inyectado para v5.6) ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1000; // Resolución optimizada para CRM
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Conversión a JPEG con calidad 0.7 (70%)
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve({
                            base64Data: dataUrl.split(',')[1],
                            contentType: 'image/jpeg',
                            name: file.name.replace(/\.[^/.]+$/, "") + ".jpg"
                        });
                    };
                };
            });
        };

        const getMexicoDate = () => {
            return new Intl.DateTimeFormat('en-CA', {
                timeZone: 'America/Mexico_City',
                year: 'numeric', month: '2-digit', day: '2-digit'
            }).format(new Date());
        };

        const generateSyncId = () => `SYNC_${Date.now()}_${Math.random().toString(36).substr(2, 9).toUpperCase()}`;

        const toInputDate = (str) => {
            if (!str || !str.includes('/')) return str;
            const [d, m, y] = str.split('/');
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        };

        const toSheetDate = (str) => {
            if (!str) return '';
            if (str.includes('/')) return str;
            const [y, m, d] = str.split('-');
            return `${d}/${m}/${y}`;
        };

        const addToBlackBox = (action, payload) => {
            const history = JSON.parse(localStorage.getItem('crm_blackbox_25') || '[]');
            history.unshift({ timestamp: new Date().getTime(), action, payload });
            if (history.length > 25) history.pop();
            localStorage.setItem('crm_blackbox_25', JSON.stringify(history));
        };

        const downloadBackup = (data, name, process = 'RESPALDO') => {
            const timestamp = new Date().getTime();
            const cleanName = name.replace(/\s+/g, '_');
            const fileName = `${cleanName}_${process}_${timestamp}.json`;
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const href = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = href;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const App = () => {
            const [user, setUser] = useState(localStorage.getItem('crm_user') || null);
            const [theme, setTheme] = useState(localStorage.getItem('crm_theme') || 'ocean');
            const [agents, setAgents] = useState([]);
            const [clients, setClients] = useState([]);
            const [loading, setLoading] = useState(false);
            const [modal, setModal] = useState(null);
            const [selectedClient, setSelectedClient] = useState(null);
            const [filters, setFilters] = useState({ name: '', status: '', interest: '', dateRange: '' });
            const [statusAlert, setStatusAlert] = useState(null);
            const [pendingCount, setPendingCount] = useState(0);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const fileInputRef = useRef(null);
            const isSyncing = useRef(false);

            const activeTheme = THEMES[theme];
            const entriesPerPage = 15;

            useEffect(() => {
                fetchAgents();
                if (user) {
                    fetchClients(user);
                    processQueue();
                }
                const timer = setInterval(() => { processQueue(); }, 30000);
                return () => clearInterval(timer);
            }, [user]);

            useEffect(() => {
                setCurrentPage(1);
            }, [filters]);

            const processQueue = async () => {
                if (isSyncing.current) return;
                const queue = JSON.parse(localStorage.getItem('crm_sync_queue') || '[]');
                setPendingCount(queue.length);
                if (queue.length === 0) return;

                isSyncing.current = true;
                const newQueue = [...queue];
                let changed = false;

                for (let i = 0; i < newQueue.length; i++) {
                    const item = newQueue[i];
                    try {
                        const res = await fetch(item.endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(item.payload)
                        });
                        const data = await res.json();
                        if (data.status === 'success' || (data.message && data.message.includes('ya existe'))) {
                            newQueue.splice(i, 1);
                            i--;
                            changed = true;
                        } else { break; }
                    } catch (err) {
                        break;
                    }
                }

                if (changed) {
                    localStorage.setItem('crm_sync_queue', JSON.stringify(newQueue));
                    setPendingCount(newQueue.length);
                    if (user) fetchClients(user);
                }
                isSyncing.current = false;
            };

            const handleCloseModal = () => {
                setModal(null);
                setSelectedClient(null);
                processQueue();
            };

            const fetchAgents = async () => {
                try {
                    const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/agents');
                    const data = await res.json();
                    if (Array.isArray(data)) setAgents(data);
                } catch (err) { console.error(err); }
            };

            const fetchClients = async (name) => {
                setLoading(true);
                try {
                    const res = await fetch(`https://crmasesorasapi.libresdeumas.com/api/clients?asesora=${name}&t=${Date.now()}`);
                    const data = await res.json();
                    setClients(data);
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            const handleLogin = async (name, password) => {
                setLoading(true);
                try {
                    const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nombre: name, password })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setUser(name);
                        localStorage.setItem('crm_user', name);
                        fetchClients(name);
                    } else {
                        setStatusAlert({ type: 'error', title: 'Acceso Denegado', message: data.message || "Credenciales inválidas" });
                    }
                } catch (err) {
                    setStatusAlert({ type: 'error', title: 'Fallo de Red', message: "No se pudo conectar con el servidor." });
                }
                setLoading(false);
            };

            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.nombre_original) {
                            setSelectedClient(data.client_reference);
                            setModal('edit');
                        } else {
                            setModal('new');
                        }
                        window._importedBackup = data;
                    } catch (err) {
                        setStatusAlert({ type: 'error', title: 'Archivo Inválido', message: "Formato de respaldo no reconocido." });
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const filteredClients = useMemo(() => {
                const search = filters.name.toLowerCase();
                const today = new Date(new Intl.DateTimeFormat('en-US', { timeZone: 'America/Mexico_City' }).format(new Date()));
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);

                let result = clients.filter(c => {
                    const matchesSearch = c.Nombre.toLowerCase().includes(search) || (c['Canal (Tel/WhatsApp)'] || c['Canal'] || '').toString().includes(search);
                    const matchesStatus = filters.status === '' || c['Estado Final'] === filters.status;
                    const matchesInterest = filters.interest === '' || (c['Nivel de Interés'] && c['Nivel de Interés'].includes(filters.interest));
                    let matchesDate = true;
                    if (filters.dateRange !== '') {
                        const proxStr = c['Fecha Próx. Contacto'];
                        if (!proxStr) { matchesDate = false; } else {
                            const [d, m, y] = proxStr.split('/').map(Number);
                            const proxDate = new Date(y, m - 1, d); proxDate.setHours(0, 0, 0, 0);
                            const timeVal = proxDate.getTime();
                            if (filters.dateRange === 'hoy') matchesDate = timeVal === today.getTime();
                            else if (filters.dateRange === 'mañana') matchesDate = timeVal === tomorrow.getTime();
                            else if (filters.dateRange === 'futuro') matchesDate = timeVal > tomorrow.getTime();
                            else if (filters.dateRange === 'vencido') matchesDate = timeVal < today.getTime();
                        }
                    }
                    return matchesSearch && matchesStatus && matchesInterest && matchesDate;
                });

                return result.sort((a, b) => {
                    const dateA = (a['Fecha 1er Contacto'] || '').split('/').reverse().join('');
                    const dateB = (b['Fecha 1er Contacto'] || '').split('/').reverse().join('');
                    return dateB.localeCompare(dateA);
                });
            }, [clients, filters]);

            const paginatedClients = useMemo(() => {
                const startIndex = (currentPage - 1) * entriesPerPage;
                return filteredClients.slice(startIndex, startIndex + entriesPerPage);
            }, [filteredClients, currentPage]);

            const totalPages = Math.ceil(filteredClients.length / entriesPerPage);

            if (!user) return <LoginScreen agents={agents} onLogin={handleLogin} loading={loading} theme={activeTheme} />;

            return (
                <div className={`min-h-screen ${activeTheme.bg} p-4 md:p-6 transition-all duration-500`}>
                    <header className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-md" style={{ backgroundColor: activeTheme.primary }}>
                                <i className="fas fa-users-cog text-xl"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-extrabold text-slate-800 tracking-tight uppercase">Gestión Asesora</h1>
                                <p className="text-slate-400 text-[8px] font-bold uppercase tracking-widest leading-none">Agente: <span className="text-slate-800">{user}</span> • Handshake On</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-4 mt-4 md:mt-0">
                            <button onClick={() => setShowHistoryModal(true)} title="Historial Local" className="w-10 h-10 rounded-full bg-white border border-slate-100 flex items-center justify-center text-slate-400 hover:text-sky-500 shadow-sm transition-all outline-none">
                                <i className="fas fa-history text-sm"></i>
                            </button>

                            <div className={`flex items-center gap-2 px-4 py-2 rounded-full border transition-all duration-500 ${pendingCount > 0 ? 'bg-amber-50 text-amber-600 border-amber-100 sync-active' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`}>
                                <i className={`fas ${pendingCount > 0 ? 'fa-cloud-upload-alt' : 'fa-cloud-check'} text-[10px]`}></i>
                                <span className="text-[9px] font-black uppercase tracking-widest">
                                    {pendingCount > 0 ? `${pendingCount} Sincronizando...` : 'Nube Protegida'}
                                </span>
                            </div>

                            <div className="flex items-center gap-3 glass p-1.5 rounded-full shadow-sm border border-white">
                                {Object.keys(THEMES).map(t => (
                                    <button key={t} onClick={() => { setTheme(t); localStorage.setItem('crm_theme', t); }} className={`w-6 h-6 rounded-full transition-all ${theme === t ? 'ring-2 ring-offset-1 ring-slate-300 scale-105' : 'opacity-40 hover:opacity-100'}`} style={{ backgroundColor: THEMES[t].primary }} />
                                ))}
                                <div className="w-px h-4 bg-slate-200 mx-1" />
                                <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="text-slate-300 hover:text-red-500 p-1.5 transition-colors border-none outline-none bg-transparent"><i className="fas fa-power-off text-sm"></i></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 mb-6">
                            <input type="text" placeholder="Filtrar prospecto..." className="w-full px-5 py-3 rounded-2xl border-none shadow-sm font-semibold text-sm focus:ring-2 focus:ring-offset-1 ring-sky-300 outline-none transition-all" value={filters.name} onChange={e => setFilters({ ...filters, name: e.target.value })} />
                            <select className="px-5 py-3 rounded-2xl border-none shadow-sm font-semibold text-sm text-slate-500 outline-none cursor-pointer" value={filters.dateRange} onChange={e => setFilters({ ...filters, dateRange: e.target.value })}>
                                <option value="">Vencimiento</option>
                                <option value="vencid">Retrasados</option>
                                <option value="hoy">Para Hoy</option>
                                <option value="mañana">Para Mañana</option>
                                <option value="futuro">Próximos</option>
                            </select>
                            <select className="px-5 py-3 rounded-2xl border-none shadow-sm font-semibold text-sm text-slate-500 outline-none cursor-pointer" value={filters.status} onChange={e => setFilters({ ...filters, status: e.target.value })}>
                                <option value="">Estado</option>
                                {ESTADO_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                            </select>
                            <select className="px-5 py-3 rounded-2xl border-none shadow-sm font-semibold text-sm text-slate-500 outline-none cursor-pointer" value={filters.interest} onChange={e => setFilters({ ...filters, interest: e.target.value })}>
                                <option value="">Interés</option>
                                {INTERES_OPTIONS.map(o => <option key={o} value={o.split(' <')[0]}>{o.split(' <')[0]}</option>)}
                            </select>
                            <button onClick={() => fileInputRef.current.click()} className="bg-slate-100 text-slate-500 font-bold py-3 px-4 rounded-2xl shadow-sm hover:bg-slate-200 transition-all flex items-center justify-center gap-2 uppercase text-[10px] tracking-wider border border-slate-200 outline-none">
                                <i className="fas fa-file-import"></i> Backup
                            </button>
                            <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportJSON} />
                            <button onClick={() => setModal('new')} className="text-white font-bold py-3 px-6 rounded-2xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 uppercase text-[10px] tracking-wider border-none outline-none" style={{ backgroundColor: activeTheme.primary }}>
                                <i className="fas fa-plus"></i> Registrar
                            </button>
                        </div>

                        <div className="glass rounded-[2.5rem] shadow-xl overflow-hidden border border-white">
                            <div className="overflow-x-auto custom-scroll">
                                <table className="w-full text-left table-auto">
                                    <thead className="bg-slate-50/40 border-b border-slate-100">
                                        <tr className="text-slate-400 text-[9px] uppercase font-black tracking-widest">
                                            <th className="px-6 py-4">Nombre</th>
                                            <th className="px-6 py-4">Teléfono</th>
                                            <th className="px-6 py-4">Interés</th>
                                            <th className="px-6 py-4">Cita</th>
                                            <th className="px-6 py-4">Estado</th>
                                            <th className="px-6 py-4 text-right pr-10">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {paginatedClients.length > 0 ? paginatedClients.map((c, i) => (
                                            <tr key={i} className="hover:bg-white/60 transition-colors">
                                                <td className="px-6 py-4 font-bold text-slate-700 text-xs">{c.Nombre}</td>
                                                <td className="px-6 py-4 text-[11px] text-slate-500">{c['Canal (Tel/WhatsApp)'] || c['Canal'] || '--'}</td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-2 py-0.5 rounded text-[8px] font-bold uppercase ${c['Nivel de Interés'] && c['Nivel de Interés'].includes('Alto') ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-400'}`}>
                                                        {c['Nivel de Interés'] ? c['Nivel de Interés'].split(' <')[0] : 'N/A'}
                                                    </span>
                                                </td>
                                                <td className={`px-6 py-4 text-[10px] font-bold ${(() => {
                                                        if (!c['Fecha Próx. Contacto']) return 'text-slate-400';
                                                        const [d, m, y] = c['Fecha Próx. Contacto'].split('/').map(Number);
                                                        const pDate = new Date(y, m - 1, d); pDate.setHours(0, 0, 0, 0);
                                                        const mxToday = new Date(new Intl.DateTimeFormat('en-US', { timeZone: 'America/Mexico_City' }).format(new Date()));
                                                        mxToday.setHours(0, 0, 0, 0);
                                                        if (pDate < mxToday) return 'text-red-500';
                                                        if (pDate.getTime() === mxToday.getTime()) return 'text-orange-500';
                                                        return 'text-sky-600';
                                                    })()
                                                    }`}>{c['Fecha Próx. Contacto'] || '--'}</td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-2 py-1 rounded-lg border text-[8px] font-bold uppercase tracking-tight ${c['Estado Final'] === 'Venta' ? 'bg-green-50 text-green-700 border-green-100' :
                                                            c['Estado Final'] === 'No interesado' ? 'bg-red-50 text-red-700 border-red-100' :
                                                                c['Estado Final'] === 'Contactar más tarde' ? 'bg-slate-50 text-slate-400 border-slate-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'
                                                        }`}>{c['Estado Final']}</span>
                                                </td>
                                                <td className="px-6 py-4 text-right pr-10">
                                                    <button onClick={() => { setSelectedClient(c); setModal('edit'); }} className="w-9 h-9 rounded-xl bg-white shadow-sm flex items-center justify-center ml-auto hover:bg-sky-50 hover:text-sky-600 transition-all border border-slate-100 outline-none">
                                                        <i className="fas fa-folder-open text-slate-300 text-sm"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr><td colSpan="6" className="py-20 text-center opacity-20 font-black uppercase text-xs tracking-widest">Sin resultados</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>

                            {totalPages > 1 && (
                                <div className="p-6 flex justify-center items-center gap-2 bg-slate-50/20 border-t border-slate-100">
                                    <button
                                        disabled={currentPage === 1}
                                        onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                        className="w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:bg-white disabled:opacity-30 transition-all border-none outline-none"
                                    >
                                        <i className="fas fa-chevron-left text-xs"></i>
                                    </button>

                                    {[...Array(totalPages)].map((_, i) => {
                                        const page = i + 1;
                                        if (totalPages > 7 && Math.abs(currentPage - page) > 2 && page !== 1 && page !== totalPages) {
                                            if (Math.abs(currentPage - page) === 3) return <span key={page} className="text-slate-300">...</span>;
                                            return null;
                                        }
                                        return (
                                            <button
                                                key={page}
                                                onClick={() => setCurrentPage(page)}
                                                className={`w-10 h-10 rounded-xl font-bold text-xs transition-all border-none outline-none ${currentPage === page ? 'text-white shadow-lg' : 'text-slate-400 hover:bg-white'}`}
                                                style={currentPage === page ? { backgroundColor: activeTheme.primary } : {}}
                                            >
                                                {page}
                                            </button>
                                        );
                                    })}

                                    <button
                                        disabled={currentPage === totalPages}
                                        onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                        className="w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:bg-white disabled:opacity-30 transition-all border-none outline-none"
                                    >
                                        <i className="fas fa-chevron-right text-xs"></i>
                                    </button>
                                </div>
                            )}
                        </div>
                        <div className="mt-4 text-[10px] text-slate-400 font-bold uppercase tracking-widest text-center">
                            Mostrando {paginatedClients.length} de {filteredClients.length} prospectos • Ordenados por fecha de registro (desc)
                        </div>
                    </main>

                    {showHistoryModal && <HistoryModal onClose={() => setShowHistoryModal(false)} />}
                    {statusAlert && <StatusModal alert={statusAlert} onClose={() => {
                        const isSuccess = statusAlert.type === 'success';
                        setStatusAlert(null);
                        if (isSuccess && user) fetchClients(user);
                    }} />}
                    {modal === 'new' && <NewClientModal theme={activeTheme} user={user} onClose={handleCloseModal} onRefresh={() => fetchClients(user)} setStatus={setStatusAlert} onQueueChange={setPendingCount} existingClients={clients} />}
                    {modal === 'edit' && <EditClientModal theme={activeTheme} client={selectedClient} onClose={handleCloseModal} onRefresh={() => fetchClients(user)} setStatus={setStatusAlert} onQueueChange={setPendingCount} />}
                </div>
            );
        };

        const HistoryModal = ({ onClose }) => {
            const history = JSON.parse(localStorage.getItem('crm_blackbox_25') || '[]');
            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-lg rounded-[3.5rem] p-10 shadow-2xl border border-white animate-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black uppercase tracking-tighter">Caja Negra de Seguridad</h3>
                            <button onClick={onClose} className="text-slate-300 hover:text-red-500 outline-none border-none"><i className="fas fa-times text-xl"></i></button>
                        </div>
                        <p className="text-[10px] text-slate-400 font-bold uppercase mb-4 tracking-widest">Respaldo Físico de las últimas 25 gestiones</p>
                        <div className="space-y-3 max-h-[60vh] overflow-y-auto custom-scroll pr-2">
                            {history.length === 0 ? <p className="text-center py-10 text-slate-200 font-black uppercase text-[10px]">Vacío</p> :
                                history.map((h, i) => (
                                    <div key={i} className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-slate-100 transition-all">
                                        <div>
                                            <p className="text-[11px] font-black text-slate-700 uppercase leading-none mb-1">{h.payload.Nombre || h.payload.nombre_original}</p>
                                            <p className="text-[8px] font-bold text-slate-400">{h.action} • {new Date(h.timestamp).toLocaleString()}</p>
                                        </div>
                                        <button onClick={() => downloadBackup(h.payload, h.payload.Nombre || h.payload.nombre_original, h.action)} className="w-8 h-8 rounded-lg bg-white shadow-sm flex items-center justify-center text-sky-500 hover:scale-110 transition-transform"><i className="fas fa-file-download text-sm"></i></button>
                                    </div>
                                ))}
                        </div>
                        <button onClick={onClose} className="w-full mt-6 py-4 bg-slate-900 text-white rounded-2xl font-black uppercase text-[10px] tracking-widest hover:brightness-110 transition-all">Cerrar</button>
                    </div>
                </div>
            );
        };

        const StatusModal = ({ alert, onClose }) => {
            const isError = alert.type === 'error';
            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[110] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-sm rounded-[3.5rem] p-12 shadow-2xl border border-white text-center animate-in zoom-in duration-200">
                        <div className={`w-20 h-20 mx-auto rounded-3xl flex items-center justify-center text-white mb-6 shadow-lg ${isError ? 'bg-amber-500' : 'bg-emerald-500'}`}>
                            <i className={`fas ${isError ? 'fa-satellite-dish' : 'fa-check-double'} text-3xl`}></i>
                        </div>
                        <h3 className="text-xl font-black text-slate-800 uppercase tracking-tighter mb-2">{alert.title}</h3>
                        <p className="text-slate-400 text-xs font-medium mb-8 leading-relaxed">{alert.message}</p>

                        {!isError && alert.data && (
                            <button onClick={() => downloadBackup(alert.data, alert.data.Nombre || alert.data.nombre_original || 'Respaldo', 'CONFIRMADO')} className="w-full py-4 mb-3 bg-sky-50 text-sky-600 border border-sky-100 rounded-2xl font-black uppercase text-[10px] tracking-widest flex items-center justify-center gap-2">
                                <i className="fas fa-download"></i> Descargar Respaldo JSON
                            </button>
                        )}
                        <button onClick={onClose} className="w-full py-4 bg-slate-100 text-slate-800 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-slate-200 transition-all outline-none border-none">Entendido</button>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ agents, onLogin, loading, theme }) => {
            const [selected, setSelected] = useState('');
            const [pass, setPass] = useState('');
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-200 p-6">
                    <div className="max-w-md w-full glass p-12 rounded-[3.5rem] shadow-2xl text-center border border-white animate-in zoom-in duration-500">
                        <div className="w-20 h-20 mx-auto rounded-[2.5rem] flex items-center justify-center text-white mb-8 shadow-2xl" style={{ backgroundColor: theme.primary }}><i className="fas fa-fingerprint text-4xl"></i></div>
                        <h2 className="text-2xl font-black text-slate-800 tracking-tighter uppercase mb-10 leading-none">Ingreso<br />Plataforma</h2>
                        <div className="space-y-5 text-left">
                            <div className="space-y-1.5">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Nombre de Asesora</label>
                                <select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm border-none outline-none shadow-inner" value={selected} onChange={e => setSelected(e.target.value)}>
                                    <option value="">Seleccionar...</option>
                                    {agents.map(a => <option key={a} value={a}>{a}</option>)}
                                </select>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Clave de Acceso</label>
                                <input type="password" placeholder="••••••••" className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm border-none outline-none shadow-inner" value={pass} onChange={e => setPass(e.target.value)} />
                            </div>
                            <button onClick={() => onLogin(selected, pass)} disabled={loading || !selected || !pass} className="w-full py-5 rounded-2xl text-white font-black text-base shadow-2xl transition-all hover:brightness-110 active:scale-95 uppercase tracking-tighter" style={{ backgroundColor: theme.primary }}>{loading ? 'AUTENTICANDO...' : 'ENTRAR AL CRM'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NewClientModal = ({ theme, user, onClose, onRefresh, setStatus, onQueueChange, existingClients }) => {
            const [form, setForm] = useState({
                Nombre: '', Canal: '', 'Fecha 1er Contacto': toSheetDate(getMexicoDate()),
                'Nivel de Interés': INTERES_OPTIONS[2], 'Resumen Conversación': '', 'Fecha Próx. Contacto': '', 'Asesora': user, 'Estado Final': 'Seguimiento'
            });
            const [files, setFiles] = useState([]);
            const [sending, setSending] = useState(false);
            const [isFromBackup, setIsFromBackup] = useState(false);

            const duplicateFound = useMemo(() => {
                if (form.Canal.length < 10) return null;
                return existingClients.find(c => {
                    const cleanC = (c['Canal (Tel/WhatsApp)'] || c['Canal'] || '').toString().replace(/\D/g, '');
                    const cleanForm = form.Canal.replace(/\D/g, '');
                    return cleanC === cleanForm;
                });
            }, [form.Canal, existingClients]);

            useEffect(() => {
                if (window._importedBackup && !window._importedBackup.nombre_original) {
                    setForm(prev => ({ ...prev, ...window._importedBackup }));
                    setIsFromBackup(true);
                    window._importedBackup = null;
                }
            }, []);

            const save = async (e) => {
                if (e) e.preventDefault();
                if (form.Canal.length !== 10) return setStatus({ type: 'error', title: 'Dato Inválido', message: "El teléfono debe tener 10 dígitos." });
                if (sending) return;
                setSending(true);

                const syncId = generateSyncId();
                const payload = { ...form, sync_id: syncId, files_payload: files, etapa: 'nuevo' };

                addToBlackBox('REGISTRO_NUEVO', payload);
                if (!isFromBackup) downloadBackup(payload, payload.Nombre, 'NUEVO');

                const queue = JSON.parse(localStorage.getItem('crm_sync_queue') || '[]');
                queue.push({ syncId, endpoint: 'https://crmasesorasapi.libresdeumas.com/api/add-client', payload });
                localStorage.setItem('crm_sync_queue', JSON.stringify(queue));
                onQueueChange(queue.length);

                try {
                    const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/add-client', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.status === 'success' || (data.message && data.message.includes('ya existe'))) {
                        const currentQueue = JSON.parse(localStorage.getItem('crm_sync_queue') || '[]');
                        const filtered = currentQueue.filter(q => q.syncId !== syncId);
                        localStorage.setItem('crm_sync_queue', JSON.stringify(filtered));
                        onQueueChange(filtered.length);
                        setStatus({ type: 'success', title: 'Sincronizado', message: "Registro guardado exitosamente.", data: form });
                        onRefresh(); onClose();
                    } else { throw new Error(data.message); }
                } catch (err) {
                    setStatus({ type: 'error', title: 'Modo Diferido', message: "Sin conexión. Los datos están protegidos y subirán pronto.", data: form });
                    onClose();
                }
                setSending(false);
            };

            // --- AJUSTE QUIRÚRGICO DE ARCHIVOS CON COMPRESIÓN ---
            const handleFiles = async (e) => {
                const selectedFiles = Array.from(e.target.files);
                const payloads = [];
                for (const file of selectedFiles) {
                    const compressed = await compressImage(file);
                    payloads.push(compressed);
                }
                setFiles(prev => [...prev, ...payloads]);
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-xl rounded-[3rem] shadow-2xl overflow-hidden animate-in zoom-in duration-300">
                        <div className="p-10 border-b border-slate-100 flex justify-between items-center bg-slate-50/20">
                            <h3 className="text-xl font-black text-slate-800 tracking-tight uppercase leading-none">Nueva Entrada</h3>
                            <button type="button" onClick={onClose} className="w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center text-slate-300 hover:text-red-500 transition-all outline-none border-none"><i className="fas fa-times text-sm"></i></button>
                        </div>
                        <form onSubmit={save} className="p-10 space-y-5 max-h-[75vh] overflow-y-auto custom-scroll">
                            <div className="space-y-1.5">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Nombre del Prospecto</label>
                                <input required type="text" placeholder="Nombre completo" className="w-full p-4 bg-slate-50 rounded-2xl font-bold text-sm border-none shadow-inner outline-none" value={form.Nombre} onChange={e => setForm({ ...form, Nombre: e.target.value })} />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div className="space-y-1.5">
                                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4 flex justify-between">
                                        WhatsApp {duplicateFound && <span className="text-red-500 animate-pulse font-black">⚠️ DUPLICADO</span>}
                                    </label>
                                    <input required type="text" placeholder="10 dígitos" className={`w-full p-4 rounded-2xl font-bold text-sm border-none shadow-inner outline-none transition-all ${duplicateFound ? 'bg-red-50 ring-2 ring-red-100 warning-shake text-red-600' : 'bg-slate-50'}`} value={form.Canal} onChange={e => setForm({ ...form, Canal: e.target.value.replace(/\D/g, '').slice(0, 10) })} />
                                </div>
                                <div className="space-y-1.5">
                                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Estado Inicial</label>
                                    <select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm border-none shadow-inner outline-none cursor-pointer" value={form['Estado Final']} onChange={e => setForm({ ...form, 'Estado Final': e.target.value })}>{ESTADO_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                </div>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Nivel de Interés</label>
                                <select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-sm border-none shadow-inner outline-none cursor-pointer" value={form['Nivel de Interés']} onChange={e => setForm({ ...form, 'Nivel de Interés': e.target.value })}>{INTERES_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                            </div>
                            <div className="grid grid-cols-2 gap-5">
                                <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Fecha Registro</label><input required disabled type="date" value={toInputDate(form['Fecha 1er Contacto'])} className="w-full p-4 bg-slate-100 rounded-2xl font-bold text-sm border-none shadow-inner outline-none opacity-50" /></div>
                                <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Próxima Cita</label><input required type="date" value={toInputDate(form['Fecha Próx. Contacto'])} className="w-full p-4 bg-slate-50 rounded-2xl font-bold text-sm border-none shadow-inner outline-none" onChange={e => setForm({ ...form, 'Fecha Próx. Contacto': toSheetDate(e.target.value) })} /></div>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-4">Resumen de Apertura</label>
                                <textarea required placeholder="¿Cómo inició el contacto?..." className="w-full p-6 bg-slate-50 rounded-[2rem] font-medium text-sm h-28 border-none shadow-inner outline-none" value={form['Resumen Conversación']} onChange={e => setForm({ ...form, 'Resumen Conversación': e.target.value })}></textarea>
                            </div>
                            <div className="p-10 border-2 border-dashed border-slate-200 rounded-[2.5rem] text-center relative cursor-pointer hover:bg-slate-50 group transition-all">
                                <input multiple type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFiles} />
                                <i className="fas fa-camera text-4xl text-slate-200 mb-2 group-hover:text-sky-300 transition-colors"></i>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{files.length > 0 ? `✓ ${files.length} CARGADAS (Shield v5.6)` : 'CAPTURAR EVIDENCIAS'}</p>
                            </div>
                            <button type="submit" disabled={sending} className="w-full py-5 rounded-2xl text-white font-black text-base shadow-2xl transition-all border-none outline-none uppercase tracking-tighter" style={{ backgroundColor: theme.primary }}>{sending ? 'SINCRONIZANDO...' : duplicateFound ? 'GUARDAR DUPLICADO' : 'CREAR EXPEDIENTE'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const EditClientModal = ({ theme, client, onClose, onRefresh, setStatus, onQueueChange }) => {
            const [tab, setTab] = useState('base');
            const [sending, setSending] = useState(false);
            const [local, setLocal] = useState({ ...client });
            const [newPhotos, setNewPhotos] = useState([]);
            const [isFromBackup, setIsFromBackup] = useState(false);

            const isLocked = client['Estado Final'] === 'Venta' || client['Estado Final'] === 'No interesado';
            const completedList = useMemo(() => {
                let list = []; for (let i = 1; i <= 30; i++) { if (client[`Fecha Seguimiento ${i}`]) list.push({ n: i, fecha: client[`Fecha Seguimiento ${i}`], nota: client[`Notas Seguimiento ${i}`] }); } return list;
            }, [client]);
            const nextFollowUp = completedList.length > 0 ? completedList[completedList.length - 1].n + 1 : 1;

            useEffect(() => {
                if (window._importedBackup && window._importedBackup.nombre_original === client.Nombre) {
                    setLocal(prev => ({ ...prev, ...window._importedBackup.updates }));
                    setIsFromBackup(true);
                    setTab('new'); window._importedBackup = null;
                }
                if (tab === 'new') setLocal(prev => ({ ...prev, [`Fecha Seguimiento ${nextFollowUp}`]: toSheetDate(getMexicoDate()) }));
            }, [tab, nextFollowUp, client.Nombre]);

            // --- AJUSTE QUIRÚRGICO DE ARCHIVOS CON COMPRESIÓN (UPDATE) ---
            const handleFiles = async (e) => {
                const selectedFiles = Array.from(e.target.files);
                const payloads = [];
                for (const file of selectedFiles) {
                    const compressed = await compressImage(file);
                    payloads.push(compressed);
                }
                setNewPhotos(prev => [...prev, ...payloads]);
            };

            const update = async (e) => {
                if (e) e.preventDefault();
                if (sending) return;
                setSending(true);

                const syncId = generateSyncId();
                const updates = { 'Estado Final': local['Estado Final'], 'Nivel de Interés': local['Nivel de Interés'], 'Fecha Próx. Contacto': local['Fecha Próx. Contacto'], 'Comentarios': local['Comentarios'] };
                if (tab === 'new') {
                    const n = nextFollowUp;
                    updates[`Fecha Seguimiento ${n}`] = local[`Fecha Seguimiento ${n}`];
                    updates[`Notas Seguimiento ${n}`] = `Anterior: ${client['Fecha Próx. Contacto'] || 'N/A'}\n${local[`Notas Seguimiento ${n}`] || ''}`;
                }

                const finalPayload = { nombre_original: client.Nombre, updates, client_reference: client, sync_id: syncId, files_payload: newPhotos, etapa: 'seguimiento' };

                addToBlackBox('SEGUIMIENTO', finalPayload);
                if (!isFromBackup) downloadBackup(finalPayload, finalPayload.nombre_original, `SEGUIMIENTO_${nextFollowUp}`);

                const queue = JSON.parse(localStorage.getItem('crm_sync_queue') || '[]');
                queue.push({ syncId, endpoint: 'https://crmasesorasapi.libresdeumas.com/api/update-client-advanced', payload: finalPayload });
                localStorage.setItem('crm_sync_queue', JSON.stringify(queue));
                onQueueChange(queue.length);

                try {
                    const res = await fetch('https://crmasesorasapi.libresdeumas.com/api/update-client-advanced', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload)
                    });
                    const data = await res.json();
                    if (data.status === 'success' || (data.message && data.message.includes('ya existe'))) {
                        const currentQueue = JSON.parse(localStorage.getItem('crm_sync_queue') || '[]');
                        const filtered = currentQueue.filter(q => q.syncId !== syncId);
                        localStorage.setItem('crm_sync_queue', JSON.stringify(filtered));
                        onQueueChange(filtered.length);
                        setStatus({ type: 'success', title: 'Sincronizado', message: "Expediente actualizado exitosamente.", data: local });
                        onRefresh(); onClose();
                    } else { throw new Error(data.message); }
                } catch (err) {
                    setStatus({ type: 'error', title: 'Guardado Local', message: "Modo Offline activo. El blindaje subirá los cambios pronto.", data: local });
                    onClose();
                }
                setSending(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-4xl rounded-[3.5rem] shadow-2xl flex flex-col h-[85vh] overflow-hidden animate-in zoom-in duration-300">
                        <div className="p-10 flex justify-between items-center bg-white border-b border-slate-50">
                            <div><h3 className="text-xl font-black text-slate-800 tracking-tight leading-none mb-1">{client.Nombre}</h3><p className="text-[9px] font-black text-slate-300 uppercase tracking-widest">Auditoría de Expediente • v5.6</p></div>
                            <div className="flex gap-3">
                                {client.Imagenes && <a href={client.Imagenes} target="_blank" className="text-sky-600 font-bold text-[10px] bg-sky-50 px-5 py-3.5 rounded-2xl hover:bg-sky-100 flex items-center gap-2"><i className="fab fa-google-drive"></i> EXPEDIENTE</a>}
                                <button type="button" onClick={onClose} className="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 hover:text-red-500 transition-all border-none outline-none"><i className="fas fa-times text-sm"></i></button>
                            </div>
                        </div>
                        <div className="chrome-tab-container">
                            {['base', 'history', 'new', 'notes'].map(t => {
                                if (t === 'new' && isLocked) return null;
                                const icons = { base: 'fa-id-badge', history: 'fa-history', new: 'fa-edit', notes: 'fa-sticky-note' };
                                const labels = { base: 'Ficha', history: 'Historial', new: 'Nueva Gestión', notes: 'Notas' };
                                return <button key={t} type="button" onClick={() => setTab(t)} className={`chrome-tab ${tab === t ? 'chrome-tab-active' : ''}`} style={tab === t ? { color: theme.primary } : {}}><i className={`fas ${icons[t]} text-xs`}></i> {labels[t]}</button>
                            })}
                        </div>
                        <div className="flex-1 p-10 overflow-y-auto custom-scroll bg-white">
                            {tab === 'base' && <div className="space-y-8 animate-in fade-in duration-300">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                    <div className="space-y-1.5"><p className="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Registro</p><div className="read-only-box">{client['Fecha 1er Contacto']}</div></div>
                                    <div className="space-y-1.5"><p className="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Teléfono</p><div className="read-only-box">{client['Canal (Tel/WhatsApp)'] || client['Canal']}</div></div>
                                    <div className="space-y-1.5"><p className="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Asesora</p><div className="read-only-box">{client['Asesora']}</div></div>
                                    <div className="space-y-1.5"><p className="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Próx. Cita</p><div className="read-only-box text-sky-600 border-sky-100 font-bold">{client['Fecha Próx. Contacto'] || '--'}</div></div>
                                </div>
                                <div className="space-y-2">
                                    <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-1">Resumen de Apertura</p>
                                    <div className="p-8 bg-slate-50 border border-slate-100 rounded-[2.5rem] font-medium text-slate-600 italic leading-relaxed text-xs">"{client['Resumen Conversación']}"</div>
                                </div>
                            </div>}
                            {tab === 'history' && <div className="space-y-6 max-w-4xl animate-in fade-in duration-300">{completedList.map((item, idx) => (
                                <div key={idx} className="relative pl-10 border-l-2 border-slate-100 pb-8">
                                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full border-4 border-white shadow-sm" style={{ backgroundColor: theme.primary }}></div>
                                    <div className="bg-slate-50/50 p-6 rounded-[2rem] border border-slate-100">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-[10px] font-black uppercase tracking-widest" style={{ color: theme.primary }}>Gestión #{item.n}</span>
                                            <span className="text-[9px] font-bold text-slate-300 italic">{item.fecha}</span>
                                        </div>
                                        <p className="text-xs text-slate-600 font-medium whitespace-pre-wrap leading-relaxed">{item.nota}</p>
                                    </div>
                                </div>
                            ))}</div>}
                            {tab === 'new' && <div className="space-y-6 max-w-3xl animate-in fade-in duration-300">
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-300 uppercase ml-4">Fecha Gestión</label><input type="date" disabled className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold opacity-50 text-xs" value={toInputDate(local[`Fecha Seguimiento ${nextFollowUp}`])} /></div>
                                    <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-300 uppercase ml-4">Próxima Cita</label><input type="date" className="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xs shadow-inner border-none outline-none" value={toInputDate(local['Fecha Próx. Contacto'])} onChange={e => setLocal({ ...local, 'Fecha Próx. Contacto': toSheetDate(e.target.value) })} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-300 uppercase ml-4">Nivel Interés</label><select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-xs border-none shadow-inner outline-none cursor-pointer" value={local['Nivel de Interés']} onChange={e => setLocal({ ...local, 'Nivel de Interés': e.target.value })}>{INTERES_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                                    <div className="space-y-1.5"><label className="text-[9px] font-black text-slate-300 uppercase ml-4">Estado Final</label><select className="w-full p-4 rounded-2xl bg-slate-50 font-bold text-xs border-none shadow-inner outline-none cursor-pointer" value={local['Estado Final']} onChange={e => setLocal({ ...local, 'Estado Final': e.target.value })}>{ESTADO_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                                </div>
                                <textarea className="w-full p-8 bg-slate-50 rounded-[2.5rem] font-medium text-xs h-32 border-none shadow-inner outline-none" placeholder="Bitácora de la llamada o contacto..." value={local[`Notas Seguimiento ${nextFollowUp}`] || ''} onChange={e => setLocal({ ...local, [`Notas Seguimiento ${nextFollowUp}`]: e.target.value })}></textarea>
                                <div className="p-8 border-2 border-dashed border-slate-200 rounded-[2.5rem] text-center relative cursor-pointer hover:bg-slate-50 group transition-all">
                                    <input multiple type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFiles} />
                                    <i className="fas fa-camera text-3xl text-slate-200 mb-2 group-hover:text-sky-300 transition-colors"></i>
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{newPhotos.length > 0 ? `✓ ${newPhotos.length} EVIDENCIAS LISTAS` : 'ADJUNTAR CAPTURAS DE GESTIÓN'}</p>
                                </div>
                            </div>}
                            {tab === 'notes' && <div className="space-y-4 h-full animate-in fade-in duration-300">
                                <label className="text-[9px] font-black text-slate-300 uppercase tracking-widest ml-4">Anotaciones Adicionales</label>
                                <textarea className="w-full p-10 bg-slate-50 rounded-[3rem] font-medium text-xs h-full border-none shadow-inner outline-none" placeholder="Escribe aquí observaciones permanentes..." value={local['Comentarios'] || ''} onChange={e => setLocal({ ...local, 'Comentarios': e.target.value })}></textarea>
                            </div>}
                        </div>
                        <div className="p-10 bg-slate-50/30 border-t border-slate-50 flex gap-5">
                            <button type="button" onClick={onClose} className="flex-1 py-4 text-slate-400 font-black uppercase text-[10px] tracking-widest hover:bg-slate-100 rounded-2xl transition-all border-none outline-none">Descartar</button>
                            {(!isLocked && tab !== 'base') && <button type="button" onClick={update} disabled={sending} className="flex-[2] py-4 rounded-2xl text-white font-black text-base shadow-2xl hover:brightness-110 uppercase tracking-tighter transition-all border-none outline-none" style={{ backgroundColor: theme.primary }}>{sending ? 'SINCRONIZANDO...' : 'Sincronizar Handshake'}</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>